<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Benny Istanto">
<meta name="dcterms.date" content="2021-01-25">
<meta name="description" content="NOTES - 1 Mar 2022 I have write a new and comprehensive guideline on SPI, you can access via this link <https://bennyistanto">

<title>Calculate SPI using monthly rainfall data in GeoTIFF format</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../assets/image-logo/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-4d9afe2b8d18ee9fa5d0d57b5ed4214d.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-ae7d70a23c66c8df71f5a679a6f4dfc7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-1bcb2280c51331a5c09e99b999b82845.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-ae7d70a23c66c8df71f5a679a6f4dfc7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-371178116"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-371178116', { 'anonymize_ip': true});
</script>
<style>html{ scroll-behavior: smooth; }</style>


<link rel="stylesheet" href="../styles/styles.css">
</head>

<body class="nav-fixed fullcontent quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../assets/image-logo/bi-logo-full-light.png" alt="Benny Istanto Logo" class="navbar-logo light-content">
    <img src="../assets/image-logo/bi-logo-full-light.png" alt="Benny Istanto Logo" class="navbar-logo dark-content">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../csr.html"> 
<span class="menu-text">CSR</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-works" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Works</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-works">    
        <li>
    <a class="dropdown-item" href="../works.html">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../works/experiences.html">
 <span class="dropdown-text">Experiences</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../works/projects.html">
 <span class="dropdown-text">Projects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../works/consulting.html">
 <span class="dropdown-text">Consulting</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../works/maps-and-infographics.html">
 <span class="dropdown-text">Maps &amp; Infographics</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../cv.html"> 
<span class="menu-text">CV</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Calculate SPI using monthly rainfall data in GeoTIFF format</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Remote Sensing</div>
    <div class="quarto-category">Research</div>
    <div class="quarto-category">Climate</div>
  </div>
  </div>

<div>
  <div class="description">
    NOTES - 1 Mar 2022 I have write a new and comprehensive guideline on SPI, you can access via this link &lt;https://bennyistanto
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Benny Istanto </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 25, 2021</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>NOTES - 1 Mar 2022</p>
<p>I have write a new and comprehensive guideline on SPI, you can access via this link <a href="https://bennyistanto.github.io/spi/" class="uri">https://bennyistanto.github.io/spi/</a></p>
<hr>
<p>These last few months, I have tried a lot of difference formulation to calculate Standardized Precipitation Index (<a href="https://drought.unl.edu/droughtmonitoring/SPI.aspx">SPI</a>) based on rainfall data in <a href="https://www.unidata.ucar.edu/software/netcdf/">netCDF</a> format, check below blog post as a background:</p>
<ol type="1">
<li>SPI using <a href="../blog/20200706-calculate-spi-using-imerg-data">IMERG</a></li>
<li>SPI using <a href="../blog/20200710-calculate-spi-using-chirps-data">CHIRPS</a></li>
</ol>
<p>The reason why I use rainfall in netCDF format in above blog post because the software to calculate SPI: <a href="https://pypi.org/project/climate-indices/">climate-indices</a> python package will only accept single netCDF as input, and the SPI script will read the netCDF input file based on time dimension.</p>
<p>Converting raster files into netCDF is easy using <a href="https://gdal.org">GDAL</a> or other GIS software, but to make the time dimension enabled netCDF output and <a href="http://cfconventions.org/cf-conventions/v1.6.0/cf-conventions.html">CF-Compliant</a> is another story. Using <a href="http://nco.sourceforge.net">NCO</a>, I can easily rename any variable with <a href="http://nco.sourceforge.net/nco.html#ncrename">ncrename</a> and add attributes to the content with <a href="http://nco.sourceforge.net/nco.html#ncatted">ncatted</a> to fit the desired data structure. Yet, I think this is too much work if every time I update the data, I should update the attribute too.</p>
<p>Then I found this <a href="../blog/20201210-geotiff-to-netcdf-file-with-time-dimension-enabled-and-cf-compliant">solution</a>.</p>
<p>Now, I am able to convert bunch of GeoTIFF in a folder into a single netCDF file with time dimension enabled and CF-Compliant and can be accepted as input using <code>climate-indices</code> software.</p>
<p>Lets try!</p>
<p>This step-by-step guide was tested using Macbook Pro, 2.9 GHz 6-Core Intel Core i9, 32 GB 2400 MHz DDR4, running on macOS Big Sur 11.1</p>
<section id="working-directory" class="level3">
<h3 class="anchored" data-anchor-id="working-directory">0. Working directory</h3>
<p>For this test, I am working at /Users/bennyistanto/Temp/CHIRPS/SPI/Java directory. I have some folder inside this directory:</p>
<ol type="1">
<li>Download</li>
<li>Fitting</li>
<li>Input_nc</li>
<li>Input_TIF</li>
<li>Output_nc</li>
<li>Output_TEMP</li>
<li>Output_TIF</li>
<li>Script</li>
<li>Subset</li>
</ol>
<p>Feel free to use your own preferences for this setting.</p>
</section>
<section id="software-requirement" class="level3">
<h3 class="anchored" data-anchor-id="software-requirement">1. Software requirement</h3>
<p>The installation and configuration described below are performed using a bash/zsh shell on macOS. Windows users will need to install and configure a bash shell in order to follow the instruction below. Try to use&nbsp;<a href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">Windows Subsystem for Linux</a>&nbsp;for this purpose.</p>
<p>1.1. If you are new to using Bash refer to the following lessons with Software Carpentry:&nbsp;<a href="http://swcarpentry.github.io/shell-novice/" class="uri">http://swcarpentry.github.io/shell-novice/</a></p>
<p>1.2. If you don’t have&nbsp;<a href="https://brew.sh/">Homebrew</a>, you can install it by pasting below code in your macOS terminal.</p>
<ul>
<li><code>bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"</code></li>
</ul>
<p>1.3. Install wget (for downloading data). Use Hombrew to install it by pasting below code in your macOS terminal.</p>
<ul>
<li><code>brew install wget</code></li>
</ul>
<p>1.4. Download and install&nbsp;<a href="https://www.giss.nasa.gov/tools/panoply/">Panoply Data Viewer</a>&nbsp;from&nbsp;<a href="https://www.giss.nasa.gov/tools/panoply/download/">NASA GISS</a>&nbsp;on your machine:&nbsp;<a href="https://www.giss.nasa.gov/tools/panoply/download/PanoplyMacOS-4.12.2.dmg">macOS</a>,&nbsp;<a href="https://www.giss.nasa.gov/tools/panoply/download/PanoplyWin-4.12.2.zip">Windows</a>,&nbsp;<a href="https://www.giss.nasa.gov/tools/panoply/download/PanoplyJ-4.12.2.zip">Linux</a>.</p>
<p>1.5. Download and install Anaconda Python on your machine:&nbsp;<a href="https://repo.anaconda.com/archive/Anaconda3-2020.11-MacOSX-x86_64.pkg">macOS</a>,&nbsp;<a href="https://repo.anaconda.com/archive/Anaconda3-2020.11-Windows-x86_64.exe">Windows</a>,&nbsp;<a href="https://repo.anaconda.com/archive/Anaconda3-2020.11-Linux-x86_64.sh">Linux</a>.</p>
<p>1.6. Or you can use Miniconda:&nbsp;<a href="https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.pkg">macOS</a>,&nbsp;<a href="https://repo.anaconda.com/miniconda/Miniconda3-latest-Windows-x86_64.exe">Windows</a>,&nbsp;<a href="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh">Linux</a></p>
</section>
<section id="configure-the-python-environment" class="level3">
<h3 class="anchored" data-anchor-id="configure-the-python-environment">2. Configure the python environment</h3>
<p>The code for calculating SPI is written in Python 3. It is recommended to use either the&nbsp;<a href="https://docs.conda.io/en/latest/miniconda.html">Miniconda3</a>&nbsp;(minimal Anaconda) or Anaconda3 distribution. The below instructions will be Anaconda specific (although relevant to any Python&nbsp;<a href="https://virtualenv.pypa.io/en/stable/">virtual environment</a>), and assume the use of a bash shell.</p>
<p>A new Anaconda&nbsp;<a href="https://conda.io/docs/using/envs.html">environment</a>&nbsp;can be created using the&nbsp;<a href="https://conda.io/docs/">conda</a>&nbsp;environment management system that comes packaged with Anaconda. In the following examples, I’ll use an environment named <code>climate_indices</code> (any environment name can be used instead of <code>climate_indices</code>) which will be created and populated with all required dependencies through the use of the provided setup.py file.</p>
<p>2.1. First, create the Python environment:</p>
<ul>
<li><code>conda create -n climate_indices python=3.7</code></li>
</ul>
<p>2.2. The environment created can now be ‘activated’:</p>
<ul>
<li><code>conda activate climate_indices</code></li>
</ul>
<p>2.3. Install&nbsp;<a href="https://pypi.org/project/climate-indices/">climate-indices</a>&nbsp;package. Once the environment has been activated then subsequent Python commands will run in this environment where the package dependencies for this project are present. Now the package can be added to the environment along with all required modules (dependencies) via&nbsp;<a href="https://pip.pypa.io/en/stable/">pip</a>:</p>
<ul>
<li><code>pip install climate-indices</code></li>
</ul>
<p>2.4. Install Climate Data Operator (<a href="https://code.mpimet.mpg.de/projects/cdo">CDO</a>) from Max-Planck-Institut für Meteorologie using conda</p>
<ul>
<li><code>conda install -c conda-forge cdo</code></li>
</ul>
<p>2.5. Install netCDF Operator (<a href="http://nco.sourceforge.net/">NCO</a>) using conda</p>
<ul>
<li><code>conda install -c conda-forge nco</code></li>
</ul>
<p>2.6. Install jupyter and other package using conda</p>
<ul>
<li><code>conda install -c conda-forge jupyter numpy datetime gdal netCDF4</code></li>
</ul>
</section>
<section id="rainfall-data-acquisition" class="level3">
<h3 class="anchored" data-anchor-id="rainfall-data-acquisition">3. Rainfall data acquisition</h3>
<p>SPI requires monthly rainfall data, and there are many source providing global high-resolution gridded monthly rainfall data:</p>
<ul>
<li><a href="https://chc.ucsb.edu/data/chirps">CHIRPS</a></li>
<li><a href="https://disc.gsfc.nasa.gov/datasets/GPM_3IMERGM_06/summary?keywords=IMERG">IMERG</a></li>
<li><a href="https://disc.gsfc.nasa.gov/datasets/FLDAS_NOAH01_C_GL_M_001/summary?keywords=FLDAS">FLDAS</a></li>
<li><a href="https://data.nkn.uidaho.edu/dataset/monthly-climate-and-climatic-water-balance-global-terrestrial-surfaces-1958-2015">TerraClimate</a></li>
<li><a href="https://catalogue.ceda.ac.uk/uuid/89e1e34ec3554dc98594a5732622bce9">CRU</a></li>
</ul>
<p>For this step-by-step guideline, I will use CHIRPS <a href="https://data.chc.ucsb.edu/products/CHIRPS-2.0/global_monthly/tifs/">monthly data in GeoTIFF</a> format and the case study is Java island - Indonesia.</p>
<p>Why CHIRPS? It is produced at 0.05 x 0.05 degree spatial resolution, make it CHIRPS is the highest gridded rainfall data, and long-term historical data from 1981 – now.</p>
<p>3.1. Navigate to <code>Download</code> folder in the working directory. Download using&nbsp;<code>wget</code>&nbsp;all CHIRPS monthly data in GeoTIFF format from Jan 1981 to Dec 2020 (this is lot of data ~7GB zipped files, and become 27GB after extraction, please make sure you have bandwidth and unlimited data package):</p>
<ul>
<li><code>wget -r https://data.chc.ucsb.edu/products/CHIRPS-2.0/global_monthly/tifs/</code></li>
</ul>
<p>3.2. Gunzip all the downloaded files</p>
<ul>
<li><code>gunzip *.gz</code></li>
</ul>
<p>3.3. Download the Java boundary shapefile <a href="http://on.istan.to/365PSyH" class="uri">http://on.istan.to/365PSyH</a>. And save it in <code>Subset</code> directory then unzip it.</p>
<p>3.4. Still in your <code>Download</code> directory, Clip your area of interest using Java boundary and save it to <code>Input_TIF</code> directory. I will use gdalwarp command from GDAL to clip all GeoTIFF files in a folder.</p>
<ul>
<li><p><code>for i in `find *.tif`; do gdalwarp --config GDALWARP_IGNORE_BAD_CUTLINE YES -srcnodata NoData -dstnodata -9999 -cutline ../Subset/java_bnd_chirps_subset.shp $i ../Input_TIF/java_cli_$i; done</code></p>
<p>if you are using Windows, you can follow below script.</p></li>
<li><p><code>for %i IN (*.tif) do gdalwarp --config GDALWARP_IGNORE_BAD_CUTLINE YES -srcnodata NoData -dstnodata -9999 -cutline ../Subset/java_bnd_chirps_subset.shp %i ../Input_TIF/java_%i</code></p>
<p>If you have limited data connection or lazy to download ~7GB and process ~27GB data, you can get pre-processed clipped data for Java covering Jan 1981 to Dec 2020, with file size ~6.8MB. Link: <a href="https://on.istan.to/3iLu68v" class="uri">https://on.istan.to/3iLu68v</a></p></li>
</ul>
<p>3.4. Download python script/notebook that I use to convert GeoTIFF in a folder to single netCDF, save it to <code>Script</code> folder.</p>
<ul>
<li>Python script: <a href="https://gist.github.com/bennyistanto/ff16dc08cc06b5a13740323db41dc8f3" class="uri">https://gist.github.com/bennyistanto/ff16dc08cc06b5a13740323db41dc8f3</a> or <a href="https://s3.benny.istan.to/script/tiff2nc.py" class="uri">https://s3.benny.istan.to/script/tiff2nc.py</a></li>
<li>Jupyter notebook: <a href="https://github.com/wfpidn/VAMscript/blob/master/notebook/CHIRPS-GeoTIFF_to_netCDF_Java.ipynb" class="uri">https://github.com/wfpidn/VAMscript/blob/master/notebook/CHIRPS-GeoTIFF_to_netCDF_Java.ipynb</a> or <a href="https://s3.benny.istan.to/script/CHIRPS-GeoTIFF_to_netCDF_Java.ipynb" class="uri">https://s3.benny.istan.to/script/CHIRPS-GeoTIFF_to_netCDF_Java.ipynb</a></li>
</ul>
<p>You MUST adjust the folder location (replace /path/to/directory/ with yours) in line 13 and 114.</p>
<p>If you are using other data source (I assume all the data in WGS84), you need to adjust few code in:</p>
<ul>
<li>Line 31: folder location</li>
<li>Line 40: start of the date</li>
<li>Line 44: output name</li>
<li>Line 53: date attribute</li>
<li>Line 85-88: bounding box</li>
<li>Line 110: output filename structure</li>
<li>Line 114: folder location</li>
<li>Line 120-122: date character location in a filename</li>
</ul>
<p>3.5. After everything is set, then you can execute the translation process</p>
<ul>
<li>Using Python in Terminal, navigate to your <code>Script</code> directory, type <code>python tiff2nc.py</code></li>
</ul>
<p><a href="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-02.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-02.jpg" class="img-fluid"></a></p>
<ul>
<li>Wait for a few moments, you will get the output java_cli_chirps_1months_1981_2020.nc. You will find this file inside <code>Input_TIF</code> folder. Move it to <code>Input_nc</code> folder.</li>
<li>Using Jupyter, make sure you still inside conda <code>climate_indices</code> environment, type in Terminal <code>jupyter notebook</code></li>
</ul>
<p><a href="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-03.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-03.jpg" class="img-fluid"></a></p>
<ul>
<li>Navigate to your notebook directory (where you put *.ipynb file), run Cell by Cell until completed. Wait for a few moments, you will get the output java_cli_chirps_1months_1981_2020.nc. You will find this file inside <code>Input_TIF</code> folder. Move it to <code>Input_nc</code> folder.</li>
<li>You also can get this data: java_cli_chirps_1months_1981_2020.nc via this link <a href="http://on.istan.to/3iRDl7e" class="uri">http://on.istan.to/3iRDl7e</a></li>
</ul>
</section>
<section id="calculate-spi" class="level3">
<h3 class="anchored" data-anchor-id="calculate-spi">4. Calculate SPI</h3>
<p>The <a href="https://pypi.org/project/climate-indices/">climate-indices</a> software enables the user to calculate SPI using any gridded netCDF dataset, However, there are certain specifications for input files that vary based on input type.</p>
<ul>
<li>Precipitation unit must be written as ‘millimeters’, ‘milimeter’, ‘mm’, ‘inches’, ‘inch’ or ‘in’</li>
<li>Data dimension and order must be written as ‘lat’, ‘lon’, ‘time’ or ‘time’, ‘lat’, ‘lon’</li>
</ul>
<p>4.1. I have try to make script in Step 3.4. are follow above specification. To make sure everything is correct, in your Terminal - navigate to your directory where you save java_cli_chirps_1months_1981_2020.nc file: <code>Input_nc</code>. Then type <code>ncdump -h java_cli_chirps_1months_1981_2020.nc</code></p>
<p><a href="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-04.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-04.jpg" class="img-fluid"></a></p>
<p>From above picture, I can say:</p>
<ul>
<li>Time dimension is enabled, 480 is total months from Jan 1981 to Dec 2020</li>
<li>Data dimension and order are following the specification ‘time’, ‘lat’, ‘lon’</li>
<li>The unit is in ‘mm’</li>
</ul>
<p>So, everything is correct and I am ready to calculate SPI. Make sure in your Terminal still inside <code>climate_indices</code> environment.</p>
<p>Other requirements and options related to the indices calculation, please follow <a href="https://climate-indices.readthedocs.io/en/latest/#indices-processing" class="uri">https://climate-indices.readthedocs.io/en/latest/#indices-processing</a></p>
<p>4.2. In order to pre-compute fitting parameters for later use as inputs to subsequent SPI calculations I can save both gamma and Pearson distribution fitting parameters to NetCDF, and later use this file as input for SPI calculations over the same calibration period.</p>
<p>In your Terminal, run the following code.</p>
<p><code>$ spi --periodicity monthly --scales 1 2 3 6 9 12 24 36 48 60 72 --calibration_start_year 1981 --calibration_end_year 2020 --netcdf_precip /Users/bennyistanto/Temp/CHIRPS/Java/Input_nc/java_cli_chirps_1months_1981_2021.nc --var_name_precip precip --output_file_base /Users/bennyistanto/Temp/CHIRPS/Java/Output_nc/java_CHIRPS --multiprocessing all --save_params /Users/bennyistanto/Temp/CHIRPS/Java/Fitting/java_CHIRPS_fitting.nc --overwrite</code></p>
<p><a href="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-07.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-07.jpg" class="img-fluid"></a></p>
<p>The above command will compute SPI (standardized precipitation index, both gamma and Pearson Type III distributions) from an input precipitation dataset (in this case, CHIRPS precipitation dataset). The input dataset is monthly rainfall accumulation data and the calibration period used will be Jan-1981 through Dec-2020. The index will be computed at 1,2,3,6,9,12,24,36,48,60 and 72-month timescales. The output files will be &lt;out_dir&gt;/java_CHIRPS_spi_gamma_xx.nc, and &lt;out_dir&gt;/java_CHIRPS_spi_pearson_xx.nc.</p>
<p>The output files will be:</p>
<ul>
<li>1-month: <code>/Output_nc/java_CHIRPS_spi_gamma_01.nc</code></li>
<li>2-month: <code>/Output_nc/java_CHIRPS_spi_gamma_02.nc</code></li>
<li>3-month: <code>/Output_nc/java_CHIRPS_spi_gamma_03.nc</code></li>
<li>6-month: <code>/Output_nc/java_CHIRPS_spi_gamma_06.nc</code></li>
<li>9-month: <code>/Output_nc/java_CHIRPS_spi_gamma_09.nc</code></li>
<li>12-month: <code>/Output_nc/java_CHIRPS_spi_gamma_12.nc</code></li>
<li>24-month: <code>/Output_nc/java_CHIRPS_spi_gamma_24.nc</code></li>
<li>36-month: <code>/Output_nc/java_CHIRPS_spi_gamma_36.nc</code></li>
<li>48-month: <code>/Output_nc/java_CHIRPS_spi_gamma_48.nc</code></li>
<li>60-month: <code>/Output_nc/java_CHIRPS_spi_gamma_60.nc</code></li>
<li>72-month: <code>/Output_nc/java_CHIRPS_spi_gamma_72.nc</code></li>
<li>1-month: <code>/Output_nc/java_CHIRPS_spi_pearson_01.nc</code></li>
<li>2-month: <code>/Output_nc/java_CHIRPS_spi_pearson_02.nc</code></li>
<li>3-month: <code>/Output_nc/java_CHIRPS_spi_pearson_03.nc</code></li>
<li>6-month: <code>/Output_nc/java_CHIRPS_spi_pearson_06.nc</code></li>
<li>9-month: <code>/Output_nc/java_CHIRPS_spi_pearson_09.nc</code></li>
<li>12-month: <code>/Output_nc/java_CHIRPS_spi_pearson_12.nc</code></li>
<li>24-month: <code>/Output_nc/java_CHIRPS_spi_pearson_24.nc</code></li>
<li>36-month: <code>/Output_nc/java_CHIRPS_spi_pearson_36.nc</code></li>
<li>48-month: <code>/Output_nc/java_CHIRPS_spi_pearson_48.nc</code></li>
<li>60-month: <code>/Output_nc/java_CHIRPS_spi_pearson_60.nc</code></li>
<li>72-month: <code>/Output_nc/java_CHIRPS_spi_pearson_72.nc</code></li>
</ul>
<p>Parallelization will occur utilizing all CPUs.</p>
<p>For small area of interest, the calculation will fast and don’t take much time. Below is example if you processed bigger area:</p>
<ul>
<li>Monthly IMERG data, global coverage 180W - 180E, 60N - 60S, 0.1 deg spatial resolution. It takes almost 9-hours to process SPI 1-72 months.</li>
</ul>
<p><a href="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-09.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-09.jpg" class="img-fluid"></a></p>
<p>Output gamma and pearson file <a href="https://on.istan.to/2MhVnTP" class="uri">https://on.istan.to/2MhVnTP</a></p>
<p>Fitting file <a href="http://on.istan.to/3c6ZLjq" class="uri">http://on.istan.to/3c6ZLjq</a></p>
</section>
<section id="updating-procedure-when-new-data-is-available" class="level3">
<h3 class="anchored" data-anchor-id="updating-procedure-when-new-data-is-available">5. Updating procedure when new data is available</h3>
<p>What if the new data is coming (Jan 2021)? Should I re-run again for the whole periods, 1981 to date? That’s not practical as it requires large storage and time processing if you do for bigger coverage (country or regional analysis).</p>
<p>Updating SPI up to SPI72, I should have data at least 6 years back (2014) from the latest (Jan 2021). In order to avoid computation for the whole periods (1981-2021), I will process data data only for year 2014 to 2021.</p>
<p>After that, I continue the process following Step 3.4.</p>
<p>Step 4.2 demonstrates how distribution fitting parameters can be saved as NetCDF. This fittings NetCDF can then be used as pre-computed variables in subsequent SPI computations. Initial command computes both distribution fitting values and SPI for various month scales.</p>
<p>The distribution fitting variables are written to the file specified by the <code>’--save_params’</code> option.</p>
<p>The second command also computes SPI but instead of computing the distribution fitting values it loads the pre-computed fitting values from the NetCDF file specified by the <code>’--load_params’</code> option.</p>
<p>See below code:</p>
<p><code>$ spi --periodicity monthly --scales 1 2 3 6 9 12 24 36 48 60 72 --calibration_start_year 1981 --calibration_end_year 2020 --netcdf_precip /Users/bennyistanto/Temp/CHIRPS/Java/Input_nc/java_cli_chirps_1months_2014_2021.nc --var_name_precip precip --output_file_base /Users/bennyistanto/Temp/CHIRPS/Java/Output_nc/java_CHIRPS --multiprocessing all --load_params /Users/bennyistanto/Temp/CHIRPS/Java/Fitting/java_CHIRPS_fitting.nc</code></p>
<p><a href="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-08.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-08.jpg" class="img-fluid"></a></p>
</section>
<section id="visualized-the-result-using-panoply" class="level3">
<h3 class="anchored" data-anchor-id="visualized-the-result-using-panoply">6. Visualized the result using&nbsp;<a href="https://www.giss.nasa.gov/tools/panoply/">Panoply</a></h3>
<p>Let see the result.</p>
<p>6.1. From the <code>Output_nc</code> directory, right-click file java_CHIRPS_spi_gamma_3_month.nc (you can download this file from this link:&nbsp;<a href="https://on.istan.to/2MhVnTP" class="uri">https://on.istan.to/2MhVnTP</a>) and Open With Panoply.</p>
<p><a href="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-05.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-05.jpg" class="img-fluid"></a></p>
<p>6.2. From the Datasets tab select spi_gamma_3_month and click Create Plot</p>
<p><a href="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-06.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-06.jpg" class="img-fluid"></a></p>
<p>6.3. In the Create Plot window select option Georeferenced Longitude-Latitude.</p>
<p>6.4. When the Plot window opens:</p>
<ul>
<li>Array tab: Change the time into 469 to view data on Jan 2020</li>
<li>Scale tab: Change value on Min -3, Max 3, Major 6, Color Table CB_RdBu_09.cpt</li>
<li>Map tab: Change value on Center on Lon 110.0 Lat -7.5, then Zoom in the map through menu-editor Plot &gt; Zoom Plot In few times until Indonesia appear proportionally. Set grid spacing 2.0 and Labels on every grid lines.</li>
<li>Overlays tab: Change Overlay 1 to MWDB_Coasts_Countries_1.cnob</li>
</ul>
<p><a href="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-01.jpg" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="../assets/image-blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format-01.jpg" class="img-fluid"></a></p>
</section>
<section id="convert-the-result-to-geotiff" class="level3">
<h3 class="anchored" data-anchor-id="convert-the-result-to-geotiff">7. Convert the result to GeoTIFF</h3>
<p>Conversion of the result into GeoTIFF format, CDO required the variable should be in&nbsp;<code>"time, lat, lon"</code>, while the output from SPI:&nbsp;<code>java_CHIRPS_spi_xxxxx_x_month.nc</code>&nbsp;in&nbsp;<code>"lat, lon, time"</code>, you can check this via&nbsp;<code>ncdump -h file.nc</code></p>
<ul>
<li><p>Navigate your Terminal to folder <code>Output_nc</code></p></li>
<li><p>Let’s re-order the variables into&nbsp;<code>time,lat,lon</code>&nbsp;using&nbsp;<code>ncpdq</code>&nbsp;command from NCO and save the result to folder <code>Output_TEMP</code></p>
<ul>
<li><code>ncpdq -a time,lat,lon java_CHIRPS_spi_gamma_3_month.nc ../Output_TEMP/java_CHIRPS_spi_gamma_3_month_rev.nc</code></li>
</ul></li>
<li><p>Navigate your Terminal to folder <code>Output_TEMP</code></p></li>
<li><p>Check result and metadata to make sure everything is correct.</p>
<ul>
<li><code>ncdump -h java_CHIRPS_spi_gamma_3_month_rev.nc</code></li>
</ul></li>
<li><p>Then convert all SPI value into GeoTIFF with&nbsp;<code>time</code>&nbsp;dimension information as the&nbsp;<code>filename</code>&nbsp;using CDO and GDAL.</p></li>
<li><p>Navigate your Terminal to folder <code>Output_TEMP</code> and save the result to folder <code>Output_TIF</code></p>
<ul>
<li><p><code>for t in `cdo showdate java_CHIRPS_spi_gamma_3_month_rev.nc`; do</code></p>
<p><code>cdo seldate,$t java_CHIRPS_spi_gamma_3_month_rev.nc dummy.nc</code></p>
<p><code>gdal_translate -of GTiff -a_ullr 105.05 -5.05 116.25 -8.8 -a_srs EPSG:4326 -co COMPRESS=LZW -co PREDICTOR=1 dummy.nc ../Output_TIF/$t.tif</code></p>
<p><code>done</code></p></li>
</ul></li>
</ul>
<p>FINISH</p>
<p>Congrats, now you are able to calculate SPI based on monthly rainfall in GeoTIFF format.</p>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/benny\.istan\.to\/site");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© 2026, Benny Istanto.</p>
<p>Exploring Climate with GIS and Data Science, solving old problems in new ways. Turning earth observation data into actionable, life-saving insights.</p>
</div>   
    <div class="nav-footer-center">
<p>Built with <a href="https://quarto.org/">Quarto</a></p>
<div class="toc-actions"><ul><li><a href="https://github.com/bennyistanto/site/blob/main/blog/20210125-calculate-spi-using-monthly-rainfall-data-in-geotiff-format.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/bennyistanto/site/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p><a href="https://github.com/bennyistanto" aria-label="GitHub"><i class="bi bi-github"></i></a> <a href="https://linkedin.com/in/bennyistanto" aria-label="LinkedIn"><i class="bi bi-linkedin"></i></a> <a href="https://worldbank.github.io/GOST/content/staff/bennyistanto.html" aria-label="GOST"><i class="bi bi-globe"></i></a></p>
<p><a href="https://buymeacoffee.com/bennyistanto">Buy Me a Coffee</a></p>
</div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>